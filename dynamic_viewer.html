<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANGSPE Publications - Fixed Standalone</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; line-height: 1.6; color: #333; background: #fafafa; padding: 40px 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .header { padding: 40px 40px 20px; border-bottom: 1px solid #eee; }
        .header h1 { font-size: 24px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px; }
        .header p { color: #666; font-size: 14px; }
        .stats { display: flex; padding: 20px 40px; gap: 40px; border-bottom: 1px solid #eee; background: #f9f9f9; }
        .stat { text-align: center; }
        .stat-number { font-size: 20px; font-weight: 600; color: #1a1a1a; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        .search { padding: 20px 40px; border-bottom: 1px solid #eee; }
        .search input { width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; }
        .search input:focus { outline: none; border-color: #007AFF; }
        .publications { padding: 0; }
        .publication { padding: 30px 40px; border-bottom: 1px solid #eee; transition: background-color 0.2s; }
        .publication:hover { background: #f9f9f9; }
        .publication:last-child { border-bottom: none; }
        .pub-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 20px; }
        .pub-title { font-size: 16px; font-weight: 500; color: #1a1a1a; flex: 1; }
        .pub-category { font-size: 12px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 12px; white-space: nowrap; }
        .pub-meta { display: flex; gap: 20px; margin-bottom: 16px; font-size: 13px; color: #666; }
        .pub-actions { display: flex; gap: 12px; }
        .btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 6px; text-decoration: none; font-size: 13px; color: #333; background: white; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
        .btn:hover { background: #f5f5f5; border-color: #ccc; }
        .btn-primary { background: #007AFF; color: white; border-color: #007AFF; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .info { padding: 15px 40px; background: #f0f8ff; border-bottom: 1px solid #eee; font-size: 13px; color: #666; }
        .empty { padding: 60px 40px; text-align: center; color: #666; }
        @media (max-width: 600px) { 
            body { padding: 20px 10px; } 
            .container { border-radius: 0; } 
            .header, .stats, .search, .publication, .info { padding-left: 20px; padding-right: 20px; }
            .stats { flex-wrap: wrap; gap: 20px; } 
            .pub-header { flex-direction: column; align-items: flex-start; gap: 8px; } 
            .pub-meta { flex-wrap: wrap; gap: 12px; } 
            .pub-actions { flex-wrap: wrap; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è ANGSPE Publications</h1>
            <p>National Agency for Strategic Management of State Participations</p>
        </div>
        <div class="info">
            üìÅ <strong>Dynamic Version:</strong> Loads data from angspe_publications_2025.json | Updates automatically when scraper runs
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-number" id="total-count">-</div><div class="stat-label">Total</div></div>
            <div class="stat"><div class="stat-number" id="activites-count">-</div><div class="stat-label">Activity Reports</div></div>
            <div class="stat"><div class="stat-number" id="autres-count">-</div><div class="stat-label">Other Reports</div></div>
        </div>
        <div class="search">
            <input type="text" id="search-input" placeholder="Search publications...">
        </div>
        <div class="publications" id="publications"></div>
    </div>

    <script>
        let publications = [];
        let filtered = [];
        let publicationsData = null;

        // Load data dynamically from JSON file
        async function loadPublicationsData() {
            try {
                console.log('üîÑ Loading data from angspe_publications_2025.json...');
                
                const response = await fetch('angspe_publications_2025.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Data loaded successfully:', data);
                
                publicationsData = data;
                publications = data.publications || [];
                filtered = [...publications];
                
                // Update stats dynamically
                updateStats(data);
                
                console.log('üìö Publications loaded:', publications.length);
                console.log('üìä Filtered array:', filtered.length);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                
                // Show error in the UI
                document.getElementById('publications').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #c53030; background: #fed7d7; border-radius: 8px; margin: 20px;">
                        <h3>‚ùå Failed to Load Data</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>File:</strong> angspe_publications_2025.json</p>
                        <br>
                        <p><strong>Solutions:</strong></p>
                        <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
                            <li>Make sure the JSON file exists in the same folder</li>
                            <li>Run the scraper first: <code>python3 scraper.py</code></li>
                            <li>Access via HTTP server if using file:// protocol fails</li>
                        </ul>
                    </div>
                `;
                return false;
            }
        }
        
        function updateStats(data) {
            console.log('üìä Updating stats with loaded data...');
            
            const totalPubs = publications.length;
            const activitesCount = publications.filter(p => p.category === "Rapport d'activit√©s").length;
            const autresCount = publications.filter(p => p.category === "Autres rapports").length;
            
            document.getElementById('total-count').textContent = totalPubs;
            document.getElementById('activites-count').textContent = activitesCount;
            document.getElementById('autres-count').textContent = autresCount;
            
            console.log(`üìà Stats updated: ${totalPubs} total, ${activitesCount} activities, ${autresCount} others`);
        }

        function render() {
            console.log('Rendering publications...', filtered.length);
            const container = document.getElementById('publications');
            
            if (!container) {
                console.error('Publications container not found!');
                return;
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty">No publications found.</div>';
                return;
            }

            const html = filtered.map(pub => {
                console.log('Processing publication:', pub.title);
                return `
                    <div class="publication">
                        <div class="pub-header">
                            <div class="pub-title">${pub.title}</div>
                            <div class="pub-category">${pub.category || 'Other'}</div>
                        </div>
                        <div class="pub-meta">
                            <span>üìÖ ${formatDate(pub.date_posted)}</span>
                            <span>üíæ ${pub.file_size}</span>
                            <span>üìÑ ${pub.file_type}</span>
                        </div>
                        <div class="pub-actions">
                            <a href="${pub.download_url}" target="_blank" class="btn btn-primary">Download PDF</a>
                            <button onclick="copy('${pub.download_url}')" class="btn">Copy Link</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Generated HTML length:', html.length);
            container.innerHTML = html;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown';
            try {
                const [day, month, year] = dateStr.split('/');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch {
                return dateStr;
            }
        }

        function copy(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copied to clipboard!');
            });
        }

        function search() {
            const term = document.getElementById('search-input').value.toLowerCase();
            console.log('Searching for:', term);
            
            filtered = publications.filter(pub =>
                pub.title.toLowerCase().includes(term) ||
                pub.category.toLowerCase().includes(term)
            );
            
            console.log('Filtered results:', filtered.length);
            render();
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', search);

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOM loaded, initializing page...');
            
            // Show loading state
            document.getElementById('publications').innerHTML = `
                <div style="padding: 60px; text-align: center; color: #666;">
                    <h3>üîÑ Loading Publications...</h3>
                    <p>Fetching data from angspe_publications_2025.json</p>
                </div>
            `;
            
            // Load data and render
            const success = await loadPublicationsData();
            if (success) {
                render();
                console.log('‚úÖ Page initialization complete');
            } else {
                console.log('‚ùå Page initialization failed');
            }
        });

        // Backup initialization for older browsers
        window.addEventListener('load', async function() {
            // Only run if data hasn't been loaded yet
            if (publications.length === 0) {
                console.log('üîÑ Backup initialization...');
                const success = await loadPublicationsData();
                if (success) {
                    render();
                }
            }
        });
    </script>
</body>
</html>
